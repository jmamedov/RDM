@page "/"
@using RDM.Core.Entities
@using RDM.Blazor.Services
@inject ISourceSystemService SourceSystemService
@inject IProductEntityTypeService EntityTypeService
@inject IHierarchyTypeService HierarchyTypeService
@inject IRegionalLocaleService LocaleService
@inject ISourceNodeService SourceNodeService
@inject INodeBillOfMaterialService BomService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Reference Data Manager</PageTitle>

<div class="rdm-container">
    <!-- Left Panel -->
    <div class="left-panel">
        <h2 class="panel-title">Reference Data Manager</h2>

        <!-- Source Systems -->
        <div class="filter-section">
            <div class="section-header">
                <h3 class="filter-title">Source Systems</h3>
                <div class="section-actions">
                    <button class="btn-icon-action" @onclick="ShowSourceSystemDialog" title="Add Source System">
                        ➕
                    </button>
                </div>
            </div>
            <div class="tree-container">
                @if (sourceSystems != null)
                {
                    @foreach (var system in sourceSystems)
                    {
                        <SourceSystemTreeNode System="@system"
                                              SelectedId="@selectedSourceSystemId"
                                              OnSelect="@HandleSourceSystemSelect"
                                              OnEdit="@EditSourceSystem"
                                              OnDelete="@HandleSourceSystemDelete" />
                    }
                }
            </div>
        </div>

        <!-- Entity Type Filter -->
        <div class="filter-section">
            <div class="section-header">
                <label class="filter-label">Entity Type</label>
                <div class="section-actions">
                    <button class="btn-icon-action" @onclick="ShowEntityTypeDialog" title="Add Entity Type">
                        ➕
                    </button>
                </div>
            </div>
            <select class="filter-select" @bind="selectedEntityTypeId" @bind:after="LoadSourceNodes">
                <option value="">All Types</option>
                @if (entityTypes != null)
                {
                    @foreach (var type in entityTypes)
                    {
                        <option value="@type.Id">@type.Name</option>
                    }
                }
            </select>
            @if (selectedEntityTypeId.HasValue && selectedEntityTypeId.Value > 0)
            {
                <button class="btn-icon-action mt-1" @onclick="EditSelectedEntityType" title="Edit Selected">
                    ✏️ Edit
                </button>
            }
        </div>

        <!-- Locale Filter -->
        <div class="filter-section">
            <div class="section-header">
                <label class="filter-label">Locale</label>
                <div class="section-actions">
                    <button class="btn-icon-action" @onclick="ShowLocaleDialog" title="Add Locale">
                        ➕
                    </button>
                </div>
            </div>
            <select class="filter-select" @bind="selectedLocaleCode" @bind:after="LoadSourceNodes">
                <option value="">All Locales</option>
                @if (locales != null)
                {
                    @foreach (var locale in locales)
                    {
                        <option value="@locale.Code">@locale.Name</option>
                    }
                }
            </select>
            @if (!string.IsNullOrEmpty(selectedLocaleCode))
            {
                <button class="btn-icon-action mt-1" @onclick="EditSelectedLocale" title="Edit Selected">
                    ✏️ Edit
                </button>
            }
        </div>
    </div>

    <!-- Right Panel (Main Content) -->
    <div class="right-panel">
        <!-- Source Nodes Grid -->
        <div class="nodes-panel" id="nodesPanel">
            <div class="panel-header">
                <h3 class="panel-header-title">Source Nodes</h3>
                <button class="btn btn-primary" @onclick="ShowNodeDialog">
                    <span class="btn-icon">➕</span> Add Node
                </button>
            </div>

            <div class="table-container">
                <table class="data-table" tabindex="0" @onkeydown="HandleNodesKeyDown" @ref="nodesTableRef">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Entity Type</th>
                            <th>Locale</th>
                            <th>Source System</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (sourceNodes != null && sourceNodes.Any())
                        {
                            @for (int i = 0; i < sourceNodes.Count; i++)
                            {
                                var node = sourceNodes[i];
                                var index = i;
                                <tr class="@(selectedNode?.Id == node.Id ? "selected" : "")"
                                    @onclick="@(() => SelectNode(node))"
                                    data-index="@index">
                                    <td>@node.Code</td>
                                    <td>@node.Name</td>
                                    <td>@node.Description</td>
                                    <td>@node.EntityType?.Name</td>
                                    <td>@node.Locale?.Name</td>
                                    <td>@node.SourceSystem?.Name</td>
                                    <td>
                                        <button class="btn-icon-action" @onclick="@(() => EditNode(node))" @onclick:stopPropagation="true">
                                            ✏️
                                        </button>
                                        <button class="btn-icon-action" @onclick="@(() => DeleteNode(node.Id))" @onclick:stopPropagation="true">
                                            🗑️
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="empty-state">No nodes found. Select filters or add a new node.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle" id="resizeHandle">
            <div class="resize-handle-bar"></div>
        </div>

        <!-- Bill of Materials Panel -->
        <div class="bom-panel" id="bomPanel">
            <div class="panel-header">
                <div style="flex: 1;">
                    <h3 class="panel-header-title" style="margin-bottom: 0.5rem;">
                        Hierarchy (Bill of Materials)
                        @if (selectedNode != null)
                        {
                            <span> - @selectedNode.Name</span>
                        }
                    </h3>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-size: 0.875rem; font-weight: 500;">Hierarchy Type:</label>
                            <select class="filter-select" style="width: 200px; padding: 0.375rem;"
                                    @bind="selectedHierarchyTypeId" @bind:after="LoadBillOfMaterials">
                                <option value="">All Types</option>
                                @if (hierarchyTypes != null)
                                {
                                    @foreach (var type in hierarchyTypes)
                                    {
                                        <option value="@type.Id">@type.Name</option>
                                    }
                                }
                            </select>
                            <button class="btn-icon-action" @onclick="ShowHierarchyTypeDialog" title="Manage Hierarchy Types">
                                ⚙️
                            </button>
                        </div>
                    </div>
                </div>
                @if (selectedNode != null)
                {
                    <button class="btn btn-success" @onclick="ShowBomDialog">
                        <span class="btn-icon">➕</span> Add Child
                    </button>
                }
            </div>

            <div class="table-container">
                <table class="data-table" tabindex="0" @onkeydown="HandleBomKeyDown" @ref="bomTableRef">
                    <thead>
                        <tr>
                            <th>Hierarchy Type</th>
                            <th>@GetParentColumnLabel()</th>
                            <th>@GetChildColumnLabel()</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (billOfMaterials != null && billOfMaterials.Any())
                        {
                            @for (int i = 0; i < billOfMaterials.Count; i++)
                            {
                                var bom = billOfMaterials[i];
                                var index = i;
                                <tr class="@(selectedBomIndex == index ? "selected" : "")"
                                    @onclick="@(() => SelectBom(index))"
                                    data-index="@index">
                                    <td>@bom.HierarchyType?.Name</td>
                                    <td>@bom.ParentNode?.Code - @bom.ParentNode?.Name</td>
                                    <td>@bom.ChildNode?.Code - @bom.ChildNode?.Name</td>
                                    <td>
                                        <button class="btn-icon-action" @onclick="@(() => DeleteBom(bom))" @onclick:stopPropagation="true">
                                            🗑️
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else if (selectedNode == null)
                        {
                            <tr>
                                <td colspan="4" class="empty-state">Select a node to view its hierarchy</td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="empty-state">No hierarchy relationships found</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Node Dialog -->
@if (showNodeDialog)
{
    <SourceNodeDialog Node="@editingNode"
                      Locales="@locales"
                      EntityTypes="@entityTypes"
                      SourceSystems="@allSourceSystems"
                      DefaultSourceId="@selectedSourceSystemId"
                      DefaultEntityTypeId="@selectedEntityTypeId"
                      DefaultLocaleCode="@selectedLocaleCode"
                      OnSave="@HandleNodeSave"
                      OnCancel="@HideNodeDialog" />
}

<!-- BOM Dialog -->
@if (showBomDialog && selectedNode != null)
{
    <BomDialog ParentNode="@selectedNode"
               HierarchyTypes="@hierarchyTypes"
               SourceNodes="@sourceNodes"
               OnSave="@HandleBomSave"
               OnCancel="@HideBomDialog" />
}

<!-- Source System Dialog -->
@if (showSourceSystemDialog)
{
    <SourceSystemDialog System="@editingSourceSystem"
                        AllSystems="@allSourceSystems"
                        OnSave="@HandleSourceSystemSave"
                        OnCancel="@HideSourceSystemDialog" />
}

<!-- Entity Type Dialog -->
@if (showEntityTypeDialog)
{
    <EntityTypeDialog EntityType="@editingEntityType"
                      OnSave="@HandleEntityTypeSave"
                      OnCancel="@HideEntityTypeDialog" />
}

<!-- Hierarchy Type Dialog -->
@if (showHierarchyTypeDialog)
{
    <HierarchyTypeDialog HierarchyType="@editingHierarchyType"
                         OnSave="@HandleHierarchyTypeSave"
                         OnCancel="@HideHierarchyTypeDialog" />
}

<!-- Locale Dialog -->
@if (showLocaleDialog)
{
    <LocaleDialog Locale="@editingLocale"
                  OnSave="@HandleLocaleSave"
                  OnCancel="@HideLocaleDialog" />
}

@code {
    private List<SourceSystem>? sourceSystems;
    private List<SourceSystem>? allSourceSystems;
    private List<ProductEntityType>? entityTypes;
    private List<HierarchyType>? hierarchyTypes;
    private List<RegionalLocale>? locales;
    private List<SourceNode>? sourceNodes;
    private List<NodeBillOfMaterial>? billOfMaterials;
    private List<NodeBillOfMaterial>? allBillOfMaterials;

    private long? selectedSourceSystemId;
    private long? selectedEntityTypeId;
    private string? selectedLocaleCode;
    private int? selectedHierarchyTypeId;
    private SourceNode? selectedNode;
    private int selectedBomIndex = -1;

    private ElementReference nodesTableRef;
    private ElementReference bomTableRef;

    private bool showNodeDialog;
    private bool showBomDialog;
    private bool showSourceSystemDialog;
    private bool showEntityTypeDialog;
    private bool showHierarchyTypeDialog;
    private bool showLocaleDialog;

    private SourceNode? editingNode;
    private SourceSystem? editingSourceSystem;
    private ProductEntityType? editingEntityType;
    private HierarchyType? editingHierarchyType;
    private RegionalLocale? editingLocale;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("initializeResizer");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing resizer: {ex.Message}");
            }
        }
    }

    private async Task LoadData()
    {
        sourceSystems = await SourceSystemService.GetHierarchyAsync();
        allSourceSystems = await SourceSystemService.GetAllAsync();
        entityTypes = await EntityTypeService.GetAllAsync();
        hierarchyTypes = await HierarchyTypeService.GetAllAsync();
        locales = await LocaleService.GetAllAsync();
        await LoadSourceNodes();
    }

    private async Task LoadSourceNodes()
    {
        sourceNodes = await SourceNodeService.GetAllAsync(selectedSourceSystemId, selectedEntityTypeId, selectedLocaleCode);
        StateHasChanged();
    }

    private async Task HandleSourceSystemSelect(long systemId)
    {
        selectedSourceSystemId = systemId;
        await LoadSourceNodes();
    }

    private async Task HandleSourceSystemDelete(long systemId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this system?");
        if (confirmed)
        {
            await SourceSystemService.DeleteAsync(systemId);
            await LoadData();
        }
    }

    private async Task SelectNode(SourceNode node)
    {
        selectedNode = node;
        selectedBomIndex = -1;
        await LoadBillOfMaterials();
    }

    private void SelectBom(int index)
    {
        selectedBomIndex = index;
    }

    private async Task LoadBillOfMaterials()
    {
        if (selectedNode == null)
        {
            billOfMaterials = null;
            allBillOfMaterials = null;
            return;
        }

        allBillOfMaterials = await BomService.GetAllAsync(selectedNode.Id);

        if (selectedHierarchyTypeId.HasValue && selectedHierarchyTypeId.Value > 0)
        {
            billOfMaterials = allBillOfMaterials
                .Where(b => b.HierarchyTypeId == selectedHierarchyTypeId.Value)
                .ToList();
        }
        else
        {
            billOfMaterials = allBillOfMaterials;
        }
    }

    private string GetParentColumnLabel()
    {
        if (selectedNode?.EntityType?.Name != null)
        {
            return selectedNode.EntityType.Name;
        }
        return "Parent";
    }

    private string GetChildColumnLabel()
    {
        if (billOfMaterials == null || !billOfMaterials.Any())
        {
            return "Child";
        }

        var childEntityTypes = billOfMaterials
            .Where(b => b.ChildNode?.EntityType?.Name != null)
            .Select(b => b.ChildNode!.EntityType!.Name)
            .Distinct()
            .ToList();

        if (childEntityTypes.Count == 1)
        {
            return childEntityTypes[0];
        }

        return "Child";
    }

    private async Task HandleNodesKeyDown(KeyboardEventArgs e)
    {
        if (sourceNodes == null || !sourceNodes.Any())
            return;

        int currentIndex = selectedNode != null
            ? sourceNodes.FindIndex(n => n.Id == selectedNode.Id)
            : -1;

        switch (e.Key)
        {
            case "ArrowDown":
                if (currentIndex < sourceNodes.Count - 1)
                {
                    await SelectNode(sourceNodes[currentIndex + 1]);
                    await ScrollRowIntoView(nodesTableRef, currentIndex + 1);
                }
                break;

            case "ArrowUp":
                if (currentIndex > 0)
                {
                    await SelectNode(sourceNodes[currentIndex - 1]);
                    await ScrollRowIntoView(nodesTableRef, currentIndex - 1);
                }
                else if (currentIndex == -1 && sourceNodes.Any())
                {
                    await SelectNode(sourceNodes[0]);
                    await ScrollRowIntoView(nodesTableRef, 0);
                }
                break;

            case "Enter":
                if (selectedNode != null)
                {
                    EditNode(selectedNode);
                }
                break;

            case "Delete":
                if (selectedNode != null)
                {
                    await DeleteNode(selectedNode.Id);
                }
                break;

            case "Home":
                if (sourceNodes.Any())
                {
                    await SelectNode(sourceNodes[0]);
                    await ScrollRowIntoView(nodesTableRef, 0);
                }
                break;

            case "End":
                if (sourceNodes.Any())
                {
                    await SelectNode(sourceNodes[^1]);
                    await ScrollRowIntoView(nodesTableRef, sourceNodes.Count - 1);
                }
                break;
        }
    }

    private async Task HandleBomKeyDown(KeyboardEventArgs e)
    {
        if (billOfMaterials == null || !billOfMaterials.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                if (selectedBomIndex < billOfMaterials.Count - 1)
                {
                    SelectBom(selectedBomIndex + 1);
                    await ScrollRowIntoView(bomTableRef, selectedBomIndex);
                }
                else if (selectedBomIndex == -1 && billOfMaterials.Any())
                {
                    SelectBom(0);
                    await ScrollRowIntoView(bomTableRef, 0);
                }
                break;

            case "ArrowUp":
                if (selectedBomIndex > 0)
                {
                    SelectBom(selectedBomIndex - 1);
                    await ScrollRowIntoView(bomTableRef, selectedBomIndex);
                }
                break;

            case "Delete":
                if (selectedBomIndex >= 0 && selectedBomIndex < billOfMaterials.Count)
                {
                    await DeleteBom(billOfMaterials[selectedBomIndex]);
                }
                break;

            case "Home":
                if (billOfMaterials.Any())
                {
                    SelectBom(0);
                    await ScrollRowIntoView(bomTableRef, 0);
                }
                break;

            case "End":
                if (billOfMaterials.Any())
                {
                    SelectBom(billOfMaterials.Count - 1);
                    await ScrollRowIntoView(bomTableRef, billOfMaterials.Count - 1);
                }
                break;
        }
    }

    private async Task ScrollRowIntoView(ElementReference tableRef, int rowIndex)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollRowIntoView", tableRef, rowIndex);
        }
        catch (Exception)
        {
            // Ignore JavaScript errors
        }
    }

    private void ShowNodeDialog()
    {
        editingNode = null;
        showNodeDialog = true;
    }

    private void EditNode(SourceNode node)
    {
        editingNode = node;
        showNodeDialog = true;
    }

    private void HideNodeDialog()
    {
        showNodeDialog = false;
        editingNode = null;
    }

    private async Task HandleNodeSave(SourceNode node)
    {
        try
        {
            if (editingNode != null)
            {
                node.Id = editingNode.Id;
                await SourceNodeService.UpdateAsync(node);
            }
            else
            {
                await SourceNodeService.CreateAsync(node);
            }
            await LoadSourceNodes();
            HideNodeDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving node: {ex.Message}");
        }
    }

    private async Task DeleteNode(long nodeId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this node?");
        if (confirmed)
        {
            try
            {
                await SourceNodeService.DeleteAsync(nodeId);
                await LoadSourceNodes();
                if (selectedNode?.Id == nodeId)
                {
                    selectedNode = null;
                    billOfMaterials = null;
                    allBillOfMaterials = null;
                }
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting node: {ex.Message}");
            }
        }
    }

    private void ShowBomDialog()
    {
        showBomDialog = true;
    }

    private void HideBomDialog()
    {
        showBomDialog = false;
    }

    private async Task HandleBomSave(NodeBillOfMaterial bom)
    {
        try
        {
            await BomService.CreateAsync(bom);
            await LoadBillOfMaterials();
            HideBomDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving hierarchy: {ex.Message}");
        }
    }

    private async Task DeleteBom(NodeBillOfMaterial bom)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this hierarchy relationship?");
        if (confirmed)
        {
            try
            {
                await BomService.DeleteAsync(bom.HierarchyTypeId, bom.ParentNodeId, bom.ChildNodeId);
                await LoadBillOfMaterials();
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting hierarchy: {ex.Message}");
            }
        }
    }

    // Source System Management
    private void ShowSourceSystemDialog()
    {
        editingSourceSystem = null;
        showSourceSystemDialog = true;
    }

    private void EditSourceSystem(SourceSystem system)
    {
        editingSourceSystem = system;
        showSourceSystemDialog = true;
    }

    private void HideSourceSystemDialog()
    {
        showSourceSystemDialog = false;
        editingSourceSystem = null;
    }

    private async Task HandleSourceSystemSave(SourceSystem system)
    {
        try
        {
            if (editingSourceSystem != null)
            {
                system.Id = editingSourceSystem.Id;
                await SourceSystemService.UpdateAsync(system);
            }
            else
            {
                await SourceSystemService.CreateAsync(system);
            }
            await LoadData();
            HideSourceSystemDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving source system: {ex.Message}");
        }
    }

    // Entity Type Management
    private void ShowEntityTypeDialog()
    {
        editingEntityType = null;
        showEntityTypeDialog = true;
    }

    private void EditSelectedEntityType()
    {
        if (selectedEntityTypeId.HasValue)
        {
            editingEntityType = entityTypes?.FirstOrDefault(t => t.Id == selectedEntityTypeId.Value);
            showEntityTypeDialog = true;
        }
    }

    private void HideEntityTypeDialog()
    {
        showEntityTypeDialog = false;
        editingEntityType = null;
    }

    private async Task HandleEntityTypeSave(ProductEntityType entityType)
    {
        try
        {
            if (editingEntityType != null)
            {
                entityType.Id = editingEntityType.Id;
                await EntityTypeService.UpdateAsync(entityType);
            }
            else
            {
                await EntityTypeService.CreateAsync(entityType);
            }
            entityTypes = await EntityTypeService.GetAllAsync();
            HideEntityTypeDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving entity type: {ex.Message}");
        }
    }

    // Hierarchy Type Management
    private void ShowHierarchyTypeDialog()
    {
        editingHierarchyType = null;
        showHierarchyTypeDialog = true;
    }

    private void EditHierarchyType(HierarchyType hierarchyType)
    {
        editingHierarchyType = hierarchyType;
        showHierarchyTypeDialog = true;
    }

    private void HideHierarchyTypeDialog()
    {
        showHierarchyTypeDialog = false;
        editingHierarchyType = null;
    }

    private async Task HandleHierarchyTypeSave(HierarchyType hierarchyType)
    {
        try
        {
            if (editingHierarchyType != null)
            {
                hierarchyType.Id = editingHierarchyType.Id;
                await HierarchyTypeService.UpdateAsync(hierarchyType);
            }
            else
            {
                await HierarchyTypeService.CreateAsync(hierarchyType);
            }
            hierarchyTypes = await HierarchyTypeService.GetAllAsync();
            HideHierarchyTypeDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving hierarchy type: {ex.Message}");
        }
    }

    // Locale Management
    private void ShowLocaleDialog()
    {
        editingLocale = null;
        showLocaleDialog = true;
    }

    private void EditSelectedLocale()
    {
        if (!string.IsNullOrEmpty(selectedLocaleCode))
        {
            editingLocale = locales?.FirstOrDefault(l => l.Code == selectedLocaleCode);
            showLocaleDialog = true;
        }
    }

    private void HideLocaleDialog()
    {
        showLocaleDialog = false;
        editingLocale = null;
    }

    private async Task HandleLocaleSave(RegionalLocale locale)
    {
        try
        {
            if (editingLocale != null)
            {
                await LocaleService.UpdateAsync(locale);
            }
            else
            {
                await LocaleService.CreateAsync(locale);
            }
            locales = await LocaleService.GetAllAsync();
            HideLocaleDialog();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving locale: {ex.Message}");
        }
    }
}