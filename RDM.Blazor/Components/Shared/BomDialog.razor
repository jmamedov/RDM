@* BomDialog.razor - Place in Components/Shared/ folder *@
@using RDM.Core.Entities
@inject IJSRuntime JS

<div class="modal-overlay" id="bomModal" @onclick="HandleCancel" tabindex="0" @onkeydown="HandleKeyDown">
 <div class="modal-content" @onclick:stopPropagation="true">
 <h3 class="modal-title">Add Hierarchy Relationship</h3>

 <div class="form-group">
 <label class="form-label">Parent Node</label>
 <input type="text" class="form-input" value="@($"{ParentNode.Code} - {ParentNode.Name}")" disabled />
 </div>

 <div class="form-group">
 <label class="form-label">Hierarchy Type *</label>
 <select class="form-input" @bind="hierarchyTypeId" required @ref="hierarchyTypeSelect">
 <option value="0">Select...</option>
 @if (HierarchyTypes != null)
 {
 @foreach (var type in HierarchyTypes)
 {
 <option value="@type.Id">@type.Name</option>
 }
 }
 </select>
 </div>

 <div class="form-group">
 <label class="form-label">Child Node *</label>
 <select class="form-input" @bind="childNodeId" required>
 <option value="0">Select...</option>
 @if (SourceNodes != null)
 {
 @foreach (var node in SourceNodes.Where(n => n.Id != ParentNode.Id))
 {
 <option value="@node.Id">@node.Code - @node.Name</option>
 }
 }
 </select>
 </div>

 <div class="modal-actions">
 <button class="btn btn-secondary" @onclick="HandleCancel">Cancel</button>
 <button class="btn btn-success" @onclick="HandleSave">Add</button>
 </div>
 </div>
</div>

@code {
 [Parameter] public SourceNode ParentNode { get; set; } = default!;
 [Parameter] public List<HierarchyType>? HierarchyTypes { get; set; }
 [Parameter] public List<SourceNode>? SourceNodes { get; set; }
 [Parameter] public EventCallback<NodeBillOfMaterial> OnSave { get; set; }
 [Parameter] public EventCallback OnCancel { get; set; }

 private int hierarchyTypeId =0;
 private long childNodeId =0;

 private ElementReference hierarchyTypeSelect;
 private bool shouldFocus = false;
 private bool trapActive = false;

 protected override void OnParametersSet()
 {
 hierarchyTypeId =0;
 childNodeId =0;
 shouldFocus = true;
 }

 protected override async Task OnAfterRenderAsync(bool firstRender)
 {
 if (shouldFocus)
 {
 shouldFocus = false;
 await JS.InvokeVoidAsync("focusElement", hierarchyTypeSelect);
 if (!trapActive)
 {
 await JS.InvokeVoidAsync("trapFocus", "#bomModal");
 trapActive = true;
 }
 }
 }

 private async Task HandleSave()
 {
 if (hierarchyTypeId ==0 || childNodeId ==0)
 {
 return;
 }

 await ReleaseTrap();
 var bom = new NodeBillOfMaterial
 {
 HierarchyTypeId = hierarchyTypeId,
 ParentNodeId = ParentNode.Id,
 ChildNodeId = childNodeId
 };
 await OnSave.InvokeAsync(bom);
 }

 private async Task HandleCancel()
 {
 await ReleaseTrap();
 await OnCancel.InvokeAsync();
 }

 private async Task ReleaseTrap()
 {
 if (trapActive)
 {
 await JS.InvokeVoidAsync("releaseTrapFocus", "#bomModal");
 trapActive = false;
 }
 }

 private async Task HandleKeyDown(KeyboardEventArgs e)
 {
 if (e.Key == "Escape")
 {
 await HandleCancel();
 }
 }
}